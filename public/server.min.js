var clients=[],client_id=0,lobbies=[],lobby_ids=[],lobby_id=0;function bc(a,b){for(i in clients)clients[i].type!=IN_LOBBY&&clients[i].socket.emit(a,b)}function msgLobby(a,b){if(a.lobby)for(i in a.lobby.players)a.lobby.players[i].socket.emit("lobby",{type:LOBBY_MSG,id:a.id,msg:b})}function sendLobby(a,b){a.socket.emit("lobby",{type:LOBBY_CREATE,id:b.id,name:b.name})}function sendLobbies(a){for(i in lobbies)sendLobby(a,lobbies[i])}
function createLobby(a,b){id=lobby_ids.length?lobby_ids.pop():lobby_id++;var c={id:id,owner:a,name:b,players:[]};lobbies.push(c);for(i in clients)clients[i].type!=IN_LOBBY&&sendLobby(clients[i],c);joinLobby(a,c)}function claimLobby(a,b){b.owner=a;for(i in b.players)b.players[i].socket.emit("lobby",{type:LOBBY_OWNER,id:b.owner.id})}
function joinLobby(a,b){a.state=IN_LOBBY;a.lobby=b;b.players.push(a);a.socket.emit("lobby",{type:LOBBY_JOIN,id:b.id});for(i in b.players)b.players[i].socket.emit("lobby",{type:LOBBY_JOINED,id:a.id,name:a.name}),b.players[i]!==a&&a.socket.emit("lobby",{type:LOBBY_JOINED,id:b.players[i].id,name:b.players[i].name});a.socket.emit("lobby",{type:LOBBY_OWNER,id:b.owner.id})}
function leaveLobby(a){if(a.lobby){lobby=a.lobby;lobby.players.splice(lobby.players.indexOf(a),1);if(0<lobby.players.length)for(i in a==lobby.owner&&claimLobby(lobby.players[0],lobby),lobby.players)lobby.players[i].socket.emit("lobby",{type:LOBBY_LEAVE,id:a.id});else bc("lobby",{type:LOBBY_DESTROY,id:lobby.id}),lobbies.splice(lobbies.indexOf(lobby),1),lobby_ids.push(lobby.id);a.state=IN_MAIN;a.lobby=null;sendLobbies(a)}}
module.exports=function(a){id=client_id++;var b={id:id,socket:a,lobby:null,state:IN_MAIN};clients.push(b);a.on("disconnect",function(){leaveLobby(b,b.lobby);clients.splice(clients.indexOf(b),1)});a.on("lobby",function(a){switch(a.type){case LOBBY_CREATE:leaveLobby(b);createLobby(b,a.name);break;case LOBBY_JOIN:leaveLobby(b);joinLobby(b,lobbies[a.id]);break;case LOBBY_LEAVE:leaveLobby(b);break;case LOBBY_MSG:msgLobby(b,a.msg);break;case LOBBY_USERNAME:b.name=a.name}});a.on("rtc",function(a){});sendLobbies(b)};
