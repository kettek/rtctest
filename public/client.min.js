(function(){function n(a,b){b.T=b.T||"div";var d=document.createElement(b.T);b.w?d.type=b.w:0;b.v?d.value=b.v:0;b.t?d.innerText=b.t:0;b.h?d.style.display="none":0;d.id=b.i||"";d.id?h[d.id]=d:0;for(evt in b.e)d.addEventListener(evt,b.e[evt]);for(c in b.c)n(d,b.c[c]);a.appendChild(d)}function u(){n(document.getElementById("view"),{i:"view",c:[{T:"input",w:"text",i:"user",v:"User"},{T:"button",i:"update_name",t:"Set Username",e:{click:function(){f.emit("lobby",{type:LOBBY_USERNAME,name:h.user.value})}}},
{T:"input",w:"text",i:"name",v:"My Lobby"},{T:"button",t:"Create Lobby",i:"create",e:{click:function(){f.emit("lobby",{type:LOBBY_CREATE,name:h.name.value})}}},{T:"div",i:"lobbies"}]});n(document.getElementById("view"),{i:"room",h:1,c:[{T:"h1",i:"title",t:"Room"},{T:"button",i:"leave",t:"Leave",e:{click:function(){f.emit("lobby",{type:LOBBY_LEAVE});h.room.style.display="none";h.view.style.display="block"}}},{T:"input",w:"text",i:"chat"},{T:"button",t:"Send",e:{click:function(){f.emit("lobby",{type:LOBBY_MSG,
msg:h.chat.value})}}},{T:"div",i:"log"}]})}function p(a){var b=document.createElement("div");b.innerText=a;h.log.appendChild(b)}function v(a,b){if(!g[a]){g[a]={id:a,name:b,element:document.createElement("div")};g[a].element.innerHTML=b;var d=document.createElement("button");d.innerText="Join";d.onclick=function(){f.emit("lobby",{type:LOBBY_JOIN,id:a})};g[a].element.appendChild(d);h.lobbies.appendChild(g[a].element)}}function q(a){g[a]&&(g[a].element.parentElement.removeChild(g[a].element),g.splice(g.indexOf(g[a]),
1))}function w(){u();f.on("connect",function(){console.log("connect")});f.on("disconnect",function(){console.log("disconnect")});f.on("error",function(){alert("ERROR on socket")});f.on("lobby",function(a){switch(a.type){case LOBBY_CREATE:v(a.id,a.name);break;case LOBBY_DESTROY:q(a.id);break;case LOBBY_JOINED:k.players[a.id]={name:a.name};p(k.players[a.id].name+" has joined");break;case LOBBY_LEAVE:a=a.id;p(k.players[a].name+" has departed");k.players.splice(k.players.indexOf(a),1);break;case LOBBY_JOIN:k.name=
g[a.id].name;k.id=a.id;for(i in g)q(g[i].id);h.title.innerText=k.name;h.view.style.display="none";h.room.style.display="block";break;case LOBBY_OWNER:k.owner=a.id;p(k.players[a.id].name+" has been crowned");break;case LOBBY_MSG:console.log("msg");console.dir(a);var b=document.createElement("div");b.innerText=k.players[a.id].name+":"+a.msg;document.getElementById("log").appendChild(b)}});f.on("rtc",x);l=y()}function y(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}
return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function z(a){e=new RTCPeerConnection(r);e.onicecandidate=function(a){f.emit("rtc",JSON.stringify({candidate:a.candidate,uuid:l}))};e.onnegotiationneeded=function(){e.createOffer().then(function(a){return e.setLocalDescription(a)}).then(function(){f.emit("rtc",JSON.stringify({desc:e.localDescription,uuid:l}))})["catch"](function(a){console.log(a)})};var b=document.createElement("div");b.innerText="Connecting...";document.getElementById("log").appendChild(b);
a?(m=e.createDataChannel("chat"),t()):e.ondatachannel=function(a){m=a.channel;t()}}function x(a){e||z(!1);a=JSON.parse(a);a.uuid!=l&&(a.desc?(a=new RTCSessionDescription(a.desc),"offer"==a.type?e.setRemoteDescription(a).then(function(){return e.createAnswer()}).then(function(a){return e.setLocalDescription(a)}).then(function(){f.emit("rtc",JSON.stringify({desc:e.localDescription,uuid:l}))})["catch"](function(a){console.log(a)}):e.setRemoteDescription(a)["catch"](function(a){console.log(a)})):a.candidate&&
e.addIceCandidate(new RTCIceCandidate(a.candidate))["catch"](function(a){console.log(a)}))}function t(){m.onopen=function(){var a=document.createElement("div");a.innerText="... ok!";document.getElementById("chat").appendChild(a)};m.onmessage=function(a){var b=document.createElement("div");b.innerText=a.data;document.getElementById("chat").appendChild(b)}}var f,k={owner:-1,id:-1,name:"none",players:[]};navigator.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia;
window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;window.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate;window.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription;var g=[],h={},r={iceServers:[{urls:"stun:stun.services.mozilla.com"},{urls:"stun:stun.ekiga.net"},{urls:"stun:stun.l.google.com:19302"}]},l=0;signaler=null;var r=
{iceServers:[{urls:"stun:stun.services.mozilla.com"},{urls:"stun:stun.ekiga.net"},{urls:"stun:stun.l.google.com:19302"}]},l=0,e,m;window.addEventListener("load",function(){f=io({upgrade:!1,transports:["websocket"]});w()},!1)})();
